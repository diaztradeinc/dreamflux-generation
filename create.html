<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DreamFlux Create</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<h2>Generate Your Dream Image</h2>

<label>Prompt</label>
<textarea placeholder="What do you dream of?" rows="2"></textarea>

<label>Negative Prompt</label>
<textarea placeholder="What do you want to exclude?" rows="2"></textarea>

<label>Width</label>
<input type="number" id="width" value="512" min="64" max="1024" />

<label>Height</label>
<input type="number" id="height" value="512" min="64" max="1024" />

<label>Samples</label>
<input type="number" id="samples" value="1" min="1" max="4" />

<label>Steps</label>
<input type="number" id="steps" value="40" min="1" max="100" />

<label>CFG Scale</label>
<input type="number" step="0.5" min="1" max="20" value="5.0" id="cfg" />

<label>Sampler</label>
<select id="sampler">
  <option>Euler A</option>
  <option>DDIM</option>
  <option>Heun</option>
  <option>DPM++ 2M</option>
</select>

<label>Seed (optional)</label>
<input id="seed" placeholder="Random" />

<label><input type="checkbox" id="safety_checker" checked /> Enable NSFW Checker</label>
<label><input type="checkbox" id="base64" /> Return base64</label>
<label><input type="checkbox" id="instant_response" /> Instant Response</label>

<button class="start-button">Start Drawing</button>

<script>
  async function startDrawing() {
    const model = localStorage.getItem("selectedModel") || "Realistic Vision";
    const prompt = document.querySelector("textarea[placeholder='What do you dream of?']").value;
    const negative_prompt = document.querySelector("textarea[placeholder='What do you want to exclude?']").value;
    const width = parseInt(document.getElementById("width").value);
    const height = parseInt(document.getElementById("height").value);
    const samples = parseInt(document.getElementById("samples").value);
    const steps = parseInt(document.getElementById("steps").value);
    const cfg = parseFloat(document.getElementById("cfg").value);
    const sampler = document.getElementById("sampler").value;
    const seed = document.getElementById("seed").value || null;
    const safety_checker = document.getElementById("safety_checker").checked;
    const base64 = document.getElementById("base64").checked;
    const instant_response = document.getElementById("instant_response").checked;

    const body = {
      model,
      prompt,
      negative_prompt,
      width,
      height,
      samples,
      steps,
      cfg,
      sampler,
      seed,
      safety_checker,
      base64,
      instant_response
    };

    const btn = document.querySelector(".start-button");
    btn.disabled = true;
    btn.innerText = "Generating...";

    try {
      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const text = await res.text();
      let data;

      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("Response was not valid JSON:\n" + text);
      }

      if (data.image_url) {
        window.location.href = "/viewer.html?url=" + encodeURIComponent(data.image_url);
      } else {
        alert("Error: " + (data.error || "Unknown"));
        console.error("Details:", data.details || text);
      }

    } catch (err) {
      alert("Failed to generate image. Check console.");
      console.error("API error:", err);
    }

    btn.disabled = false;
    btn.innerText = "Start Drawing";
  }

  document.addEventListener("DOMContentLoaded", () => {
    const model = localStorage.getItem("selectedModel");
    const thumb = localStorage.getItem("selectedImage");
    if (model) document.getElementById("modelName")?.innerText = model;
    if (thumb) document.getElementById("modelThumb")?.src = thumb;

    document.querySelector(".start-button").addEventListener("click", startDrawing);
  });
</script>

</body>
</html>